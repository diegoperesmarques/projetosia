<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Vídeo Online</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Interact.js -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <!-- vis-timeline -->
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* Estilos customizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .media-bin-item {
            cursor: grab;
        }
        .vis-item {
            border-color: #4f46e5;
            background-color: #6366f1;
            color: white;
            border-radius: 4px;
        }
        .vis-item.vis-selected {
            border-color: #f59e0b;
            background-color: #fbbf24;
        }
        .vis-timeline {
            border: 1px solid #4a5568;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            height: 10px;
        }
        .progress-bar {
            height: 10px;
            width: 0;
            background-color: #4caf50;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-800 text-white flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-gray-900 text-white p-2 flex justify-between items-center shadow-md z-20">
        <h1 class="text-xl font-bold"> <i class="fas fa-film mr-2"></i> Editor de Vídeo Pro</h1>
        <div>
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                <i class="fas fa-download mr-2"></i> Exportar
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Media Bin & Tools -->
        <aside class="w-1/4 bg-gray-900 p-4 flex flex-col overflow-y-auto">
            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-2"> <i class="fas fa-photo-video mr-2"></i> Mídia</h2>
                <div class="bg-gray-800 p-4 rounded-lg border-2 border-dashed border-gray-600 text-center">
                    <input type="file" id="media-upload" multiple class="hidden" accept="video/*,image/*,audio/*">
                    <label for="media-upload" class="cursor-pointer">
                        <i class="fas fa-upload fa-2x text-gray-500 mb-2"></i>
                        <p>Arraste e solte ou clique para importar</p>
                        <p class="text-xs text-gray-400 mt-1">Vídeos, Áudios e Imagens</p>
                    </label>
                </div>
            </div>
            <div id="media-bin" class="flex-1 space-y-2">
                <!-- Arquivos de mídia importados aparecerão aqui -->
            </div>
        </aside>

        <!-- Right Panel: Player & Timeline -->
        <main class="w-3/4 flex flex-col p-4">
            
            <!-- Preview Player -->
            <div class="flex-1 bg-black mb-4 rounded-lg shadow-lg flex items-center justify-center relative">
                 <canvas id="preview-canvas" class="w-full h-full"></canvas>
                 <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 p-2 flex items-center space-x-4">
                    <button id="play-pause-btn" class="text-white"><i class="fas fa-play fa-lg"></i></button>
                    <span id="current-time" class="text-sm">00:00</span>
                    <div class="w-full bg-gray-600 rounded-full h-1.5">
                        <div id="playback-progress" class="bg-indigo-500 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <span id="total-duration" class="text-sm">00:00</span>
                 </div>
            </div>

            <!-- Timeline Controls -->
            <div class="flex items-center space-x-4 mb-2 p-2 bg-gray-900 rounded-lg">
                <button id="add-track-btn" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg" title="Adicionar Trilha"><i class="fas fa-plus"></i></button>
                <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg" title="Dividir (Split)"><i class="fas fa-cut"></i></button>
                <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg" title="Aparar (Trim)"><i class="fas fa-crop-alt"></i></button>
                <button id="zoom-in-btn" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button id="zoom-out-btn" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
            </div>

            <!-- Timeline -->
            <div id="timeline-container" class="w-full h-64 bg-gray-900 rounded-lg shadow-inner"></div>
        </main>
    </div>

    <script>
        $(document).ready(function() {
            // --- MÓDULO 1: GERENCIAMENTO DE MÍDIA E LINHA DO TEMPO ---

            const mediaBin = $('#media-bin');
            const mediaUpload = $('#media-upload');
            const timelineContainer = document.getElementById('timeline-container');
            let mediaCounter = 0; // Para IDs únicos dos itens de mídia
            let timeline;
            let items = new vis.DataSet();
            let groups = new vis.DataSet();
            let trackCounter = 1;

            // 1) Linha do Tempo (Timeline) Interativa
            function initializeTimeline() {
                // Adiciona a primeira trilha de vídeo e áudio
                groups.add([
                    { id: 'video1', content: 'Vídeo 1 <i class="fas fa-video ml-2 text-indigo-300"></i>', value: 1 },
                    { id: 'audio1', content: 'Áudio 1 <i class="fas fa-volume-up ml-2 text-teal-300"></i>', value: 2 }
                ]);

                const options = {
                    stack: false,
                    start: 0,
                    end: 60000, // 60 segundos iniciais
                    min: 0,
                    max: 3600000, // 1 hora de limite
                    zoomMin: 1000, // 1 segundo
                    zoomMax: 3600000,
                    editable: {
                        add: false,
                        updateTime: true,
                        updateGroup: true,
                        remove: true,
                        overrideItems: false
                    },
                    margin: {
                        item: 10,
                        axis: 5
                    },
                    orientation: 'bottom',
                    // Formata a escala de tempo para min:seg
                    format: {
                        minorLabels: {
                            millisecond: 'ss.SSS',
                            second: 'mm:ss',
                            minute: 'mm:ss',
                            hour: 'HH:mm',
                        },
                        majorLabels: {
                            millisecond: 'HH:mm:ss',
                            second: 'mm:ss',
                            minute: 'HH:mm',
                            hour: 'HH:mm'
                        }
                    },
                    // Converte o valor do tempo para um formato legível
                    timeAxis: {
                        scale: 'second',
                        step: 5
                    },
                    onMove: function(item, callback) {
                        // Lógica para quando um clipe é movido
                        item.start = Math.max(0, item.start);
                        item.end = item.start + (item.end - item.start);
                        callback(item);
                    }
                };

                timeline = new vis.Timeline(timelineContainer, items, groups, options);
            }
            
            // Adicionar nova trilha
            $('#add-track-btn').on('click', function() {
                trackCounter++;
                const newVideoTrackId = `video${trackCounter}`;
                const newAudioTrackId = `audio${trackCounter}`;
                groups.add([
                    { id: newVideoTrackId, content: `Vídeo ${trackCounter} <i class="fas fa-video ml-2 text-indigo-300"></i>`, value: trackCounter * 2 -1 },
                    { id: newAudioTrackId, content: `Áudio ${trackCounter} <i class="fas fa-volume-up ml-2 text-teal-300"></i>`, value: trackCounter * 2 }
                ]);
            });
            
            // Controles de Zoom
            $('#zoom-in-btn').on('click', () => timeline.zoomIn(0.5));
            $('#zoom-out-btn').on('click', () => timeline.zoomOut(0.5));


            // 2) Gestão de Arquivos (Media Bin)
            mediaUpload.on('change', function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    for(const file of files) {
                        addMediaToBin(file);
                    }
                }
            });
            
            // Prevenir comportamento padrão de arrastar e soltar
            $(document).on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
            $(document).on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const files = e.originalEvent.dataTransfer.files;
                 if (files.length > 0) {
                    for(const file of files) {
                        addMediaToBin(file);
                    }
                }
            });


            function addMediaToBin(file) {
                const mediaId = `media-${mediaCounter++}`;
                const objectURL = URL.createObjectURL(file);
                let mediaElement;
                let iconClass;
                let duration = 0;

                const mediaItemHTML = `
                    <div id="${mediaId}" class="media-bin-item bg-gray-700 p-2 rounded-lg flex items-center space-x-3" draggable="true">
                        <div class="w-16 h-10 bg-black rounded flex items-center justify-center">
                           <!-- Thumbnail virá aqui -->
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium truncate">${file.name}</p>
                            <div class="progress-bar-container">
                                <div class="progress-bar"></div>
                            </div>
                        </div>
                    </div>
                `;
                mediaBin.append(mediaItemHTML);
                
                // Simula o progresso do upload
                const progressBar = $(`#${mediaId} .progress-bar`);
                let width = 0;
                const interval = setInterval(function() {
                    if (width >= 100) {
                        clearInterval(interval);
                        progressBar.parent().remove(); // Remove a barra de progresso após o "upload"
                    } else {
                        width++;
                        progressBar.css('width', width + '%');
                    }
                }, 20);


                if (file.type.startsWith('video/')) {
                    iconClass = 'fas fa-video text-indigo-400';
                    mediaElement = document.createElement('video');
                    mediaElement.preload = 'metadata';
                    mediaElement.onloadedmetadata = function() {
                        duration = mediaElement.duration * 1000; // em milissegundos
                        $(`#${mediaId}`).data('duration', duration);
                        generateVideoThumbnail(mediaElement, mediaId);
                    };
                } else if (file.type.startsWith('image/')) {
                    iconClass = 'fas fa-image text-purple-400';
                    mediaElement = document.createElement('img');
                    duration = 5000; // Duração padrão para imagens (5s)
                    $(`#${mediaId}`).data('duration', duration);
                } else if (file.type.startsWith('audio/')) {
                    iconClass = 'fas fa-volume-up text-teal-400';
                    mediaElement = document.createElement('audio');
                     mediaElement.preload = 'metadata';
                    mediaElement.onloadedmetadata = function() {
                        duration = mediaElement.duration * 1000;
                        $(`#${mediaId}`).data('duration', duration);
                    };
                }
                
                mediaElement.src = objectURL;
                $(`#${mediaId}`).data('file', file);
                $(`#${mediaId}`).data('type', file.type);
                $(`#${mediaId} .fa-video, #${mediaId} .fa-image, #${mediaId} .fa-volume-up`).replaceWith(`<i class="${iconClass} fa-2x"></i>`);

                // Adiciona evento de arrastar para o novo item
                document.getElementById(mediaId).addEventListener('dragstart', handleDragStart);
            }
            
            function generateVideoThumbnail(video, mediaId) {
                const canvas = document.createElement('canvas');
                video.onseeked = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const thumbnailUrl = canvas.toDataURL('image/jpeg');
                    const thumbnailImg = `<img src="${thumbnailUrl}" class="w-full h-full object-cover rounded">`;
                    $(`#${mediaId} .w-16.h-10`).html(thumbnailImg);
                };
                video.currentTime = 1; // Pega o frame em 1 segundo
            }


            // Lógica de Arrastar e Soltar (Drag-and-Drop)
            function handleDragStart(e) {
                const id = e.target.id;
                const type = $(`#${id}`).data('type');
                const duration = $(`#${id}`).data('duration');
                const name = $(`#${id} p`).text();

                const dragData = { id, type, duration, name };
                e.dataTransfer.setData('text/plain', JSON.stringify(dragData));
            }

            timelineContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            timelineContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const dropTime = timeline.getEventProperties(e).time.getTime();
                const group = timeline.getEventProperties(e).group;
                
                if (group === null) return; // Não soltou em uma trilha válida

                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                // Valida se o tipo de mídia corresponde à trilha
                if ((data.type.startsWith('video/') || data.type.startsWith('image/')) && !group.startsWith('video')) {
                    alert('Você só pode soltar vídeos e imagens em trilhas de vídeo.');
                    return;
                }
                if (data.type.startsWith('audio/') && !group.startsWith('audio')) {
                    alert('Você só pode soltar áudio em trilhas de áudio.');
                    return;
                }

                items.add({
                    id: new Date().getTime(),
                    group: group,
                    content: data.name,
                    start: dropTime,
                    end: dropTime + data.duration,
                    type: 'range'
                });
            });


            // Inicializa a aplicação
            initializeTimeline();
        });
    </script>
</body>
</html>
